

<script>
	window.jQuery || document.write('<script src="libraries/jquery-3.3.1.min.js"><\/script>');
</script>
<script type="text/javascript" charset="utf-8" src="libraries/popper.min.js"></script>


<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="libraries/bootstrapCollector.css">
<script type="text/javascript" charset="utf-8" src="../libraries/bootstrap.4.0.min.js"></script>


<!-- dropbox -->
<script type="text/javascript" charset="utf-8" src="../libraries/dropbox.2.5.13.min.js"></script>
<script type="text/javascript" charset="utf-8" src="libraries/dropbox.dropins.js" id="dropboxjs" data-app-key="6xumb4iloq9sz1u"></script>


<!-- lodash ! not currently used-->
<script type="text/javascript" charset="utf-8" src="libraries/lodash.4.17.4.min.js"></script>

<!-- papaparse -->
<script type="text/javascript" charset="utf-8" src="libraries/papaparse.4.3.6.min.js"></script>


<!-- bootbox -->
<script type="text/javascript" src="libraries/bootbox.4.4.0.min.js"></script>



<!--
	fix to close button being messed up, by  Pawel Rymsza  on https://stackoverflow.com/questions/48529880/bootbox-dialog-modal-bootstrap-4
-->
<style>
.bootbox .modal-header{
	display: block;
}
</style>

<style>
#game{
  position:relative;
  margin:auto;
  width:800px;
  padding:50px;
  height:800px;
  text-align: center;  
  display:none;  
}
#lobby{
  margin:auto;
  width:500px;
  padding:50px;
  max-height:600px;
  text-align: center;  
  display:none;  
}
#new_room_btn{
  width:100%;
}
#table{
  border-radius:350px;
  background-color:green;
  width:700px;
  height:600px;
}
#welcome_screen{
  margin:auto;
  width:500px;
  padding:50px;
  max-height:600px;
  text-align: center;  
}
#player_0{
  top:300px;
  left:0px;
}
#player_1{
  left:50px;
  top:100px;
}
#player_2{
  top:30px;
  left:250px;
}
#player_3{
  top:30px;
  left:450px;
}
#player_4{
  top:100px;
  left:600px;
}
#player_5{
  top:300px;
  left:700px;
}
#player_6{
  top:500px;
  left:600px;
}
#player_7{
  top:600px;
  left:450px;
}
#player_8{
  top:600px;
  left:250px;
}
#player_9{
  top:500px;
  left:50px;
}
#player_1_card_1{
  position:absolute;
  left:-200px;
  top:300px;
}
#player_1_card_2{
  position:absolute;
  left:-100px;
  top:300px;
}
#player_2_card_1{
  position:absolute;
  left:-150px;
  top:100px;
}
#player_2_card_2{
  position:absolute;
  left:-50px;
  top:100px;
}
#player_3_card_1{
  position:absolute;
  left:150px;
  top:-50px;
}
#player_3_card_2{
  position:absolute;
  left:50px;
  top:-50px;
}
#player_4_card_1{
  position:absolute;
  left:550px;
  top:-50px;
}
#player_4_card_2{
  position:absolute;
  left:650px;
  top:-50px;
}
#player_5_card_1{
  position:absolute;
  left:750px;
  top:100px;
}
#player_5_card_2{
  position:absolute;
  left:850px;
  top:100px;
}
#player_6_card_1{
  position:absolute;
  left:800px;
  top:320px;
}
#player_6_card_2{
  position:absolute;
  left:900px;
  top:320px;
}
#player_7_card_1{
  position:absolute;
  left:750px;
  top:520px;
}
#player_7_card_2{
  position:absolute;
  left:850px;
  top:520px;
}
#player_8_card_1{
  position:absolute;
  left:550px;
  top:730px;
}
#player_8_card_2{
  position:absolute;
  left:650px;
  top:730px;
}
#player_9_card_1{
  position:absolute;
  left:50px;
  top:730px;
}
#player_9_card_2{
  position:absolute;
  left:150px;
  top:730px;
}
#player_10_card_1{
  position:absolute;
  left:-150px;
  top:520px;
}
#player_10_card_2{
  position:absolute;
  left:-50px;
  top:520px;
}

#deal_cards{
  position:absolute;
  top:400px;
  left:335px;
}
#your_bet{
  position:absolute;
  top:520px;
  left:275px;
}
#middle_cards{
  position:absolute;
  top:250px;
  left:150px;
}
#winner_div{
  position:absolute;
  top:450px;
  left:0px;
  width:100%;
}
.card{
  width:100px;
  height:100px;
}
.player_space{
  position:absolute;
  background-color: white;
  border-style: solid;
  border-radius: 10px;
  padding: 10px;
  
}
</style>
<h1>Room Code:<span id="room_code_span"></span></h1>
<div id="welcome_screen">
  <h1 class="text-primary">Texas Hold-em</h1>
  <button class="btn btn-primary" id="new_room_btn">New room</button>
  <br><br>
  <div class="input-group mb-3">
    <div class="input-group-prepend">
      <span class="input-group-text">Room code</span>
    </div>
    <input type="text" class="form-control" aria-label="room code" id="room_code_input">
    <div class="input-group-append">
      <button class="input-group-text btn-primary" id="join_btn">Join</button>
    </div>
  </div>
</div>
<div id="lobby">
  <h1>Lobby</h1>
  <div id="lobby_people"></div>
  <button class="btn btn-primary" id="everybody_in_btn">Everybody's in</button>
</div>
<div id="game">
  <div id="table"></div>
  <div id="player_0" class="text-primary player_space">player 0</div>
  <div id="player_1" class="text-primary player_space">player 1</div>
  <div id="player_2" class="text-primary player_space">player 2</div>
  <div id="player_3" class="text-primary player_space">player 3</div>
  <div id="player_4" class="text-primary player_space">player 4</div>
  <div id="player_5" class="text-primary player_space">player 5</div>
  <div id="player_6" class="text-primary player_space">player 6</div>
  <div id="player_7" class="text-primary player_space">player 7</div>
  <div id="player_8" class="text-primary player_space">player 8</div>
  <div id="player_9" class="text-primary player_space">player 9</div>
  <img id="player_1_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_1_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_2_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_2_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_3_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_3_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_4_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_4_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_5_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_5_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_6_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_6_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_7_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_7_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_8_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_8_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_9_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_9_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_10_card_1" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>
  <img id="player_10_card_2" class="player_card card" src="../User/Stimuli/Cards/back-red.png"/>



  <div id="middle_cards">
    <table>
      <tr>
        <td>
          <img id="middle_1" class="card" src="../User/Stimuli/Cards/back-red.png" />
        </td>
        <td>
          <img id="middle_2" class="card" src="../User/Stimuli/Cards/back-red.png" />
        </td>
        <td>
          <img id="middle_3" class="card" src="../User/Stimuli/Cards/back-red.png" />
        </td>
        <td>
          <img id="middle_4" class="card" src="../User/Stimuli/Cards/back-red.png" />
        </td>
        <td>
          <img id="middle_5" class="card" src="../User/Stimuli/Cards/back-red.png" />
        </td>
      </tr>
    </table>
  </div>
  <h1 id="winner_div" class="text-white"></h1>
  <button id="deal_cards" class="btn btn-danger">Deal new hand</button>
  <div id="your_bet">
    <button class="btn btn-danger" id="fold_btn">Fold</button>
    <button class="btn btn-danger" id="check_call_btn">Check</button>
    <div class="input-group mb-3">
      <input type="text" class="form-control" aria-label="raise_btn" id="raise_input">
      <div class="input-group-append">
        <button class="input-group-text btn-raise" id="raise_btn">Raise</button>
      </div>
    </div>
  </div>
</div>

<script>
$("#raise_btn").on("click",function(){
  var data = {
    action: "raise",
    amount: $("#raise_input").val(),
    collector_code: settings.collector_code,
    player_name: settings.player_name, 
  }
  $.ajax({
    type: 'POST',
    url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
    data: data,
    crossDomain: true,
    timeout: 120000,
    success:function(result){
      //as it stands, this will never happen as Collector doesn't allow posts to it.
    }
  })
  .catch(function(error){
    //read the google sheet 
    /*
    ParseGSX.parseGSX(data.question_id,function(result){
      show_question(result);
    });
    */
  });
});

$("#deal_cards").on("click",function(){
  var data = {
    action: "deal",
    collector_code: settings.collector_code
  }
  $.ajax({
    type: 'POST',
    url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
    data: data,
    crossDomain: true,
    timeout: 120000,
    success:function(result){
      //as it stands, this will never happen as Collector doesn't allow posts to it.
    }
  })
  .catch(function(error){
    //read the google sheet 
    /*
    ParseGSX.parseGSX(data.question_id,function(result){
      show_question(result);
    });
    */
  });
});


settings={
  collector_code: "tbc",
  player_name: "tbc",
  this_room: "tbc",
  raw_deck: {},
  player_cards:{},
  table_cards:[],
  missing_players_showing:true
}
phase = "welcome",

phases = [
  "welcome",
  "lobby",
  "playing"
]

/*
to do list
- prevent a player stealing another player's name...?
*/

/////////////
// Actions //
/////////////
$("#join_btn").on("click",function(){
  settings.this_room = master_sheet.filter(function(row){
    return row.roomcode == $("#room_code_input").val();
  })[0];
  if(typeof(settings.this_room) == "undefined"){
    bootbox.alert("That's not a recognised room code");
  } else {
    settings.collector_code = settings.this_room.collectorcode;
    bootbox.prompt("What (nick)name do you want to use?",function(player_name){
      player_name = player_name.toUpperCase();
      settings.player_name = player_name;
      var data = {
        action: "join",
        collector_code: settings.collector_code,
        player_name: player_name,
      }
      $.ajax({
        type: 'POST',
        url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
        data: data,
        crossDomain: true,
        timeout: 120000,
        success:function(result){
          //as it stands, this will never happen as Collector doesn't allow posts to it.
        }
      })
      .catch(function(error){
        //read the google sheet 
        /*
        ParseGSX.parseGSX(data.question_id,function(result){
          show_question(result);
        });
        */
      });
    });    
  }
});
$("#everybody_in_btn").on("click",function(){
  var data = {
      action: "everybody_in",
      collector_code: settings.collector_code,
    }
    $.ajax({
      type: 'POST',
      url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
      data: data,
      crossDomain: true,
      timeout: 120000,
      success:function(result){
        //as it stands, this will never happen as Collector doesn't allow posts to it.
      }
    })
    .catch(function(error){
      //read the google sheet 
      /*
      ParseGSX.parseGSX(data.question_id,function(result){
        show_question(result);
      });
      */
    });
});
$("#new_room_btn").on("click",function(){
  settings.collector_code = makeid(12);
  bootbox.prompt("What (nick)name do you want to use?",function(player_name){
    settings.player_name = player_name.toUpperCase();
    var data = {
      action: "create_room",
      collector_code: settings.collector_code,
      player_name: player_name,
    }
    $.ajax({
      type: 'POST',
      url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
      data: data,
      crossDomain: true,
      timeout: 120000,
      success:function(result){
        //as it stands, this will never happen as Collector doesn't allow posts to it.
      }
    })
    .catch(function(error){
      //read the google sheet 
      /*
      ParseGSX.parseGSX(data.question_id,function(result){
        show_question(result);
      });
      */
    });
  });
});
$("#room_code_input").on("input",function(){
  $(this).val($(this).val().toUpperCase());
});

player_obj = {
  name:"tbc",
  amount:-1,
  wipeouts:0,
  current_round:-1
}


//based on solution by csharptest.net at https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
function makeid(length) {
  var result           = '';
  var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmonpqrstuvwxyz1234567890';
  var charactersLength = characters.length;
  for ( var i = 0; i < length; i++ ) {
    result += characters.charAt(Math.floor(Math.random() * charactersLength));
  }
  return result;
}

//based on code found at: https://raw.githubusercontent.com/drumwolf/parse-gsx/0ba67bf115eac96e0763777a4fb2c485a35e2daa/parse-gsx-ajax.js
var ParseGSX = (function() {
  var _defaultCallback = function(data) {
    console.log(data);
  };
  var _parseRawData = function(res) {
    var finalData = [];
    res.feed.entry.forEach(function(entry){
      var parsedObject = {};
      for (var key in entry) {
        if (key.substring(0,4) === "gsx$") {
          parsedObject[key.slice(4)] = entry[key]["$t"];
        }
      }
      finalData.push(parsedObject);
    });
    var processGSXData = _defaultCallback;
    processGSXData(finalData);
  };
  var parseGSX = function(spreadsheetID, callback) {
    var url = "https://spreadsheets.google.com/feeds/list/" + spreadsheetID + "/od6/public/values?alt=json";
    var ajax = $.get(url);
    if (callback) { _defaultCallback = callback; }
    $.when(ajax).then(_parseRawData);
  };
  return { parseGSX: parseGSX };
})();

$("#fold_btn").on("click",function(){
  var data = {
    action: "fold",
    collector_code: settings.collector_code,
    player_name: settings.player_name,
  }
  $.ajax({
    type: 'POST',
    url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
    data: data,
    crossDomain: true,
    timeout: 120000,
    success:function(result){
      //as it stands, this will never happen as Collector doesn't allow posts to it.
    }
  })
  .catch(function(error){
    //read the google sheet 
    /*
    ParseGSX.parseGSX(data.question_id,function(result){
      show_question(result);
    });
    */
  });
});

$("#check_call_btn").on("click",function(){
  var data = {
    action: "check_call",
    collector_code: settings.collector_code,
    player_name: settings.player_name,
  }
  $.ajax({
    type: 'POST',
    url: "https://script.google.com/macros/s/AKfycbzdLP0pkgsZ_iKKMER7ZyM6_jnguMa3FZXIorz2aVfjkG8v6Dc/exec",
    data: data,
    crossDomain: true,
    timeout: 120000,
    success:function(result){
      //as it stands, this will never happen as Collector doesn't allow posts to it.
    }
  })
  .catch(function(error){
    //read the google sheet 
    /*
    ParseGSX.parseGSX(data.question_id,function(result){
      show_question(result);
    });
    */
  });
});

function update_players(){
  function update_your_cards(roomobj){
    var your_player = roomobj.players[settings.player_name];
    //var card_1 = ;
    if(typeof(your_player) !== "undefined" &&
       typeof(your_player.current_hand) !== "undefined" &&
       typeof(your_player.current_hand[0]) !== "undefined"){
      
        if(settings.missing_players_showing){
          $(".player_card").hide();
          settings.missing_players_showing = false;
        }
        Object.keys(roomobj.players).forEach(function(player,player_no){
          this_player_no = player_no + 1;
          if(player == settings.player_name){
            $("#player_"+this_player_no+"_card_1").attr("src","../User/Stimuli/Cards/" + your_player.current_hand[0].card_file);
            $("#player_"+this_player_no+"_card_2").attr("src","../User/Stimuli/Cards/" + your_player.current_hand[1].card_file);
            $("#player_"+this_player_no+"_card_1").show();
            $("#player_"+this_player_no+"_card_2").show();
          } else {
            if(typeof(roomobj.winner) == "undefined" || roomobj.winner.length == 0){
              $("#player_"+this_player_no+"_card_1").attr("src","../User/Stimuli/Cards/back-red.png");
              $("#player_"+this_player_no+"_card_2").attr("src","../User/Stimuli/Cards/back-red.png");
              $("#player_"+this_player_no+"_card_1").show();
              $("#player_"+this_player_no+"_card_2").show();
            } else {
              if(roomobj.players[player].current_bid !== "fold"){
                $("#player_"+this_player_no+"_card_1").attr("src","../User/Stimuli/Cards/" + roomobj.players[player].current_hand[0].card_file);
                $("#player_"+this_player_no+"_card_2").attr("src","../User/Stimuli/Cards/" + roomobj.players[player].current_hand[1].card_file);
                $("#player_"+this_player_no+"_card_1").show();
                $("#player_"+this_player_no+"_card_2").show();
              } else {
                $("#player_"+this_player_no+"_card_1").attr("src","../User/Stimuli/Cards/back-red.png");
                $("#player_"+this_player_no+"_card_2").attr("src","../User/Stimuli/Cards/back-red.png");
                $("#player_"+this_player_no+"_card_1").show();
                $("#player_"+this_player_no+"_card_2").show();
              }
            }
          }
          if(roomobj.players[player].current_pot > max_bid){
            max_bid = roomobj.players[player].current_pot;
          }
        });
      

      
      //if your turn, allow you to bid
      if(your_player.current_bid == "your turn" & roomobj.winner.length == 0){
        $("#fold_btn").attr("disabled",false);
        $("#check_call_btn").attr("disabled",false);
        $("#raise_input").attr("disabled",false);
        $("#raise_btn").attr("disabled",false);
        
        //detect whether checking or calling
        var max_bid = -1;
        Object.keys(roomobj.players).forEach(function(player,player_no){
          if(roomobj.players[player].current_pot > max_bid){
            max_bid = roomobj.players[player].current_pot;
          }
        });
        
        if(max_bid > your_player.current_pot){
          $("#check_call_btn").html("Call");
        } else if(max_bid == your_player.current_pot) {
          $("#check_call_btn").html("Check");
        } else {
          bootbox.alert("something has gone wrong");
        }
        
        
      } else {
        $("#fold_btn").attr("disabled",true);
        $("#check_call_btn").attr("disabled",true);
        $("#raise_input").attr("disabled",true);
        $("#raise_btn").attr("disabled",true);
      }
      if(roomobj.winner.length > 0){
        var winner_div_html = roomobj.winner.join(" and ") + " won";
        $("#winner_div").html(winner_div_html);
        $("#deal_cards").show();
      } else {
        $("#winner_div").html("Round in progress");
        $("#deal_cards").hide();
      }
      
      switch(roomobj.round_phase){
        case 0:
          $("#middle_1").attr("src","../User/Stimuli/Cards/back-red.png");
          $("#middle_2").attr("src","../User/Stimuli/Cards/back-red.png");
          $("#middle_3").attr("src","../User/Stimuli/Cards/back-red.png");
          $("#middle_4").attr("src","../User/Stimuli/Cards/back-red.png");
          $("#middle_5").attr("src","../User/Stimuli/Cards/back-red.png");
          break;
        case 1:
          $("#middle_1").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[0].card_file);
          $("#middle_2").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[1].card_file);
          $("#middle_3").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[2].card_file);
          $("#middle_4").attr("src","../User/Stimuli/Cards/back-red.png");
          $("#middle_5").attr("src","../User/Stimuli/Cards/back-red.png");
          break;
        case 2:
          $("#middle_1").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[0].card_file);
          $("#middle_2").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[1].card_file);
          $("#middle_3").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[2].card_file);
          $("#middle_4").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[3].card_file);
          $("#middle_5").attr("src","../User/Stimuli/Cards/back-red.png");
          break
        case 3:
          $("#middle_1").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[0].card_file);
          $("#middle_2").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[1].card_file);
          $("#middle_3").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[2].card_file);
          $("#middle_4").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[3].card_file);
          $("#middle_5").attr("src","../User/Stimuli/Cards/" + roomobj.middle_cards[4].card_file);
          break;
      }
      
      
    }
  }
  var roomobj = JSON.parse(settings.this_room.roomobj);
  for(var i = 0; i< 10; i++){
    var this_player = Object.keys(roomobj.players).filter(function(player){
      return roomobj.players[player].player_no == i
    })[0];
    if(typeof(this_player) == "undefined"){
      $("#player_" + i).hide();
    } else {
      var player_html = "<h6>" + this_player + "</h6>" +
                        "<h6>Chips: " + roomobj.players[this_player].chips + "</h6>" +
                        "<h6>Bet: "   + roomobj.players[this_player].current_pot + "</h6>" +
                        "<h6>Status: "   + roomobj.players[this_player].current_bid + "</h6>";
      $("#player_" + i).html(player_html);
      if(this_player == settings.player_name){
        $("#player_" + i).removeClass("text-primary");
        $("#player_" + i).addClass("text-danger");
      }
      update_your_cards(roomobj);
      
    }
  }
}

var master_sheet;
function sheet_check(){
  ParseGSX.parseGSX("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g",function(quest_array){
    master_sheet = quest_array;
    settings.this_room = master_sheet.filter(function(row){
      return row.collectorcode == settings.collector_code;
    })[0];
    switch(phase){
      case "welcome":
        
        
        if(typeof(settings.this_room) !== "undefined"){
          phase = "lobby";
          $("#welcome_screen").hide();
          $("#lobby").fadeIn(1000);
        }
        //if(master_sheet)
        setTimeout(function(){
          sheet_check();
        },1000);
        break;
      case "lobby":
        var lobby_people_html = "";
        
        for(var i = 0; i < 10; i++){
          if(settings.this_room["player"+i] !== ""){
            lobby_people_html += "<h2 class='text-primary'>" + settings.this_room["player"+i] + "</h2>";
          }
        }
        $("#lobby_people").html(lobby_people_html);
        $("#room_code_span").html(settings.this_room.roomcode);

        if(settings.this_room.everybodyin == "TRUE"){
          phase = "playing";
          $("#lobby").hide();
          $("#game").fadeIn(1000);
          update_players();
        }
        setTimeout(function(){
          sheet_check();
        },1000);
        break;
      case "playing":
        update_players(); 
        setTimeout(function(){
          sheet_check();
        },1000);
        break;
    }
  });
}
sheet_check();

/* google scripts code:

function doGet(e){
  return initiate(e);
}

function doPost(e){
  return initiate(e);
}

function initiate(e) {
  
  var response = e.parameter;
  var action = response.action;
  switch(action){
    case "check_call":
      check_call(response.collector_code,
                  response.player_name);
      break;
    case "create_room":
      create_room(response.collector_code,
                  response.player_name);
      break;
    case "everybody_in":
      everybody_in(response.collector_code);
      break;
    case "fold":
      fold(response.collector_code,
           response.player_name);
    case "join":
      join_room(response.collector_code,
                response.player_name);
      break;
  }
}

function pilot_check_call(){
  check_call("KRj75JmD4grZ","ANT");
}

function check_call(collector_code,
                    player_name){
  
  player_name = player_name.toUpperCase();
  
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  var game_row = rowOfValue(master_sheet,   //looking within this
                            collector_code, //looking for this
                            0);             //looking in this column
  var roomobj = JSON.parse(master_sheet.getRange(game_row,3).getValues()[0]);
  
  
  var max_bid = -1;
  Object.keys(roomobj.players).forEach(function(player){
    if(roomobj.players[player].current_pot > max_bid){
      max_bid = roomobj.players[player].current_pot;
    }
  });
  
  roomobj.players[player_name].current_pot = max_bid;
  roomobj.players[player_name].last_bet  = max_bid;
  
  var not_folded = 0;
  var current_bets = [];
  Object.keys(roomobj.players).forEach(function(player){
    if(roomobj.players[player].current_bid !== "fold"){
      not_folded++;
      current_bets.push(roomobj.players[player].last_bet);
    }
  });
  master_sheet.getRange(1,18).setValue("hi - " + JSON.stringify(current_bets));
  if(current_bets.every( (val, i, arr) => val === arr[0] )){ //i.e. there are at least 2 people with equal bets so move onto the next round
    //master_sheet.getRange(1,18).setValue("hi - " + JSON.stringify(current_bets));
    roomobj.round_phase++;
    if(roomobj.round_phase > 3){
      roomobj = resolve_bets(roomobj);
    } else {
      roomobj = round_progress(roomobj);
    }
    
  } else {
    roomobj = next_player(roomobj);  
  }
  
  
  master_sheet.getRange(game_row,3).setValue(JSON.stringify(roomobj));
  
} 

function resolve_bets(roomobj){
  var best_hand = "tbc";
  var best_rank = "tbc";
  Object.keys(roomobj.players).forEach(function(player){
    //only consider if they haven't folder
    if(roomobj.players[player].current_bid !== "fold"){
      //detect what the hand is first
      var all_cards = roomobj.players[player].current_hand.concat(roomobj.middle_cards);
      [hand_description,player_best_hand] = evaluate_hand(all_cards);
    }
    
  });

  
  return roomobj;
}

function evaluate_hand(all_cards){
  //count occurrences of each suit
  var hand_summary = {
    flush:false,
    four_of_a_kind: false,
    pair:false,
    full_house: false,
    three_of_a_kind: false,
    two_pairs: false,
    straight:false,
    straight_flush:false,
    ordered_cards:[],
    possible_straights:[],
    suit_count:{
      club:0,
      diamond:0,
      heart:0,
      spade:0
    }
  }
  all_cards.forEach(function(card){
    //ordering for straight calculations later
    hand_summary.ordered_cards.push(card.card_no);
    hand_summary.ordered_cards = hand_summary.ordered_cards.sort((a, b) => a - b);
    
    //flush calculations
    hand_summary.suit_count[card.suit]++;
    if(hand_summary.suit_count[card.suit] > 4){
      //hand_summary.flush = true;
      hand_summary.flush = all_cards.filter(function(flush_card){
        return flush_card.suit == card.suit;
      });
    }
  });
  
  hand_summary.flush = hand_summary.flush.sort((a, b) => a - b); 
  while(hand_summary.flush.length > 5){      //trim to remove the next bottom
    hand_summary.splice(5,1);
  }
  
  //check straight
  var in_a_row    = [];
  var last_number = -1;
  var sequences   = [[]];
  hand_summary.ordered_cards.forEach(function(this_no){
    if(this_no == last_number + 1){
      in_a_row[in_a_row.length-1]++;
      sequences[in_a_row.length-1].push(this_no);
      if(in_a_row[in_a_row.length-1] > 4){
        hand_summary.straight = sequences[in_a_row.length-1];
      }
    } else if(this_no !== last_number){
      in_a_row.push(1);
      sequences.push([])
    }
    last_number = this_no;
  });
  while(hand_summary.straight.length > 5){
    hand_summary.splice(0,1);
  }

  // straight flush
  if(hand_summary.straight){
    //now just need to detect if it's a straight flush - filter by suit..?
    ["club","diamond","heart","spade"].forEach(function(suit){
      var suit_cards = all_cards.filter(function(card){
        return card.suit == suit;
      });
      //order the cards
      in_a_row = [];
      last_number = -1;
      sequences   = [[]];
  
      hand_summary.ordered_cards.forEach(function(this_no){
        if(this_no == last_number + 1){
          in_a_row[in_a_row.length-1]++;
          sequences[in_a_row.length-1].push(this_no);
          if(in_a_row[in_a_row.length-1] > 4){
            hand_summary.straight_flush = sequences[in_a_row.length-1];
          }
        } else if(this_no !== last_number){
          in_a_row.push(1);
        }
        last_number = this_no;
      });
    });
  }
  while(hand_summary.straight_flush.length > 5){
    hand_summary.splice(0,1);
  }

  
  //count how the hand is distributed
  var same_numbers = {};
  hand_summary.ordered_cards.forEach(function(card_no){
    if(typeof(same_numbers[card_no]) == "undefined"){
      same_numbers[card_no] = 1;
    } else {
      same_numbers[card_no]++;
    }
  });
  
   
  hand_summary.full_house = {
    three: -1,  
    two:   -1
  }; 
  hand_summary.two_pair   = {
    pair_1:-1,
    pair_2:-1,
    high:-1
  }
  hand_summary.three_kind = {
    three: -1,
    high_1:-1,
    high_2:-1
  };
  hand_summary.four_kind = {
    four: -1,
    high: -1
  }
  hand_summary.one_pair = {
    pair: -1,
    high_1:-1,
    high_2:-1,
    high_3:-1
  }

  Object.keys(same_numbers).forEach(function(same_number){
    switch(same_numbers[same_number]){
      case 4:
        hand_summary.four_kind.four = same_number;
        break;  
      case 3:
        hand_summary.three_kind.three = same_number;
        break;
      case 2:
        //full house
        if(same_number > hand_summary.full_house.two){
          hand_summary.full_house.two = same_number;
        }
        //two pair
        if(same_number > hand_summary.two_pair.pair_1){
          hand_summary.two_pair.pair_2 = hand_summary.two_pair.pair_1;
          hand_summary.two_pair.pair_1 = same_number;
        } else if(same_number > hand_summary.two_pair.pair_2){
          hand_summary.two_pair.pair_2 = same_number;
        }
        //pair
        if(same_number > hand_summary.one_pair.pair){
          hand_summary.one_pair.pair = same_number
        }
        
        break;
      case 1:
        //four_kind
        if(same_number > hand_summary.four_kind.high){
          hand_summary.four_kind.high = same_number;
        }
        //three_kind
        if(same_number > hand_summary.three_kind.high_2){
          hand_summary.three_kind.high_2 = hand_summary.three_kind.high_1;
          hand_summary.three_kind.high_1 = same_number;
        } else if(same_number > hand_summary.three_kind.high_2){
          hand_summary.three_kind.high_2 = same_number;
        }
        
        //two_pair
        if(same_number > hand_summary.two_pair.high){
          hand_summary.two_pair.high = same_number;
        }
        //one_pair
        if(same_number > hand_summary.one_pair.high_1){
          hand_summary.one_pair.high_3 = hand_summary.one_pair.high_2;
          hand_summary.one_pair.high_2 = hand_summary.one_pair.high_1;
          hand_summary.one_pair.high_1 = same_number;
        } else if(same_number > hand_summary.one_pair.high_2){
          hand_summary.one_pair.high_3 = hand_summary.one_pair.high_2;
          hand_summary.one_pair.high_2 = same_number;
        } else if(same_number > hand_summary.one_pair.high_3){
          hand_summary.one_pair.high_3 = same_number;
        }
        break;
    }
  });
  
  
  
  
  var hand_strength = 0;
  var hand_description = "";
  if(hand_summary.straight_flush !== false){
    hand_strength = "straight flush";
    hand_description = hand_summary.straight_flush;
  } else if(hand_summary.four_kind.four !== -1){
    hand_strength = "four of a kind";
    hand_description = hand_summary.four_kind;
  } else if(hand_summary.full_house.three !== -1 &&
            hand_summary.full_house.two   !== -1){
    hand_strength = "full house";
    hand_description = hand_summary.full_house;
  } else if(hand_summary.flush !== false){
    hand_strength = "flush";
    hand_description = hand_summary.flush;
  } else if(hand_summary.straight !== false){
    hand_strength = "straight";
    hand_description = hand_summary.straight;
  } else if(hand_summary.three_kind.three !== -1){
    hand_strength = "three of a kind";
    hand_description = hand_summary.three_kind;
  } else if(hand_summary.two_pair.pair_1 !== -1 &&
            hand_summary.two_pair.pair_2 !== -1){
    hand_strength = "two pairs";
    hand_description = hand_summary.two_pair;
  } else if(hand_summary.one_pair.pair !== -1){
    hand_strength = "one pair";
    hand_description = hand_summary.one_pair;
  } else {
    hand_strength = "high card";
    hand_description = hand_summary.ordered_cards;
    while(hand_description.length >5){
      hand_description.splice(0,1);
    }
  }
  
  return [hand_strength,hand_description]
  

  var hands = {
    "high_card":{
      rank:0
    },
    "pair":{
      rank:1
    },
    "2_pair":{
      rank:2
    },
    "3_kind":{
      rank:3
    },
    "straight":{
      rank:4
    },
    "flush":{
      rank:5
    },
    "full_house":{
      rank:6
    },
    "4_kind":{
      rank:7
    },
    "straight_flush":{
      rank:8
    }
  }  
}

function round_progress(roomobj){
  Object.keys(roomobj.players).forEach(function(this_player){
    roomobj.players[this_player].last_bet = -1;    
  });
  
  
  
  return(roomobj);                                  
}

function pilot_fold(){
  fold("KRj75JmD4grZ","ANT");
}

function fold(collector_code,
              player_name){
  player_name = player_name.toUpperCase();
  
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  var game_row = rowOfValue(master_sheet,   //looking within this
                            collector_code, //looking for this
                            0);             //looking in this column
  var roomobj = JSON.parse(master_sheet.getRange(game_row,3).getValues()[0]);
  
  roomobj.players[player_name].current_bid = "fold";

  
  //move onto the next player
  //check if 2+ haven't yet folded and if there's a consistent bet
  var not_folded = 0;
  var current_bets = [];
  Object.keys(roomobj.players).forEach(function(player){
    if(roomobj.players[player].current_bid !== "fold"){
      not_folded++;
      current_bets.push(roomobj.players[player].last_bet);
    }
  });
  master_sheet.getRange(1,17).setValue("not folded = " + not_folded);
   
  var round_over = false;
  if(not_folded > 1){
    if(current_bets.every( (val, i, arr) => val === arr[0] )){ //i.e. there are at least 2 people with equal bets so move onto the next round
      master_sheet.getRange(1,18).setValue(JSON.stringify(current_bets));
                                                               
      
      
    } else {                                                   //next player this round
      roomobj = next_player(roomobj);
      master_sheet.getRange(1,18).setValue("howdy");
      
    }
  } else {                                                     //settle up
    var winners_chips = count_chips(roomobj);
    Object.keys(roomobj.players).forEach(function(player){
      if(roomobj.players[player].current_bid !== "fold"){
        roomobj.players[player].chips += winners_chips;
      }
    });
    round_over = true;
  }
  

  master_sheet.getRange(game_row,3).setValue(JSON.stringify(roomobj));
  if(round_over){
    deal_cards(fill_deck(),game_row);
  }
}

function next_player(roomobj){
  var valid_player = false;
  for(var i = 1; i < Object.keys(roomobj).length; i++){
    if(valid_player == false){
      roomobj.current_bidder++;
      roomobj.current_bidder = roomobj.current_bidder % Object.keys(roomobj.players).length;
      var current_player = Object.keys(roomobj.players).filter(function(player){
        return roomobj.players[player].player_no == roomobj.current_bidder;
      })[0];
      

      if(roomobj.players[current_player].current_bid == "fold"){
        var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
        master_sheet = master_sheet.getSheetByName('Sheet1');
        
        master_sheet.getRange(3,18).setValue("not here");
      } else {
        valid_player = true;
        var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
        master_sheet = master_sheet.getSheetByName('Sheet1');
        
        master_sheet.getRange(2,18).setValue("got here");
        Object.keys(roomobj.players).forEach(function(this_player){
          if(this_player == current_player){
            roomobj.players[this_player].current_bid = "your turn";
          } else {
            if(roomobj.players[this_player].current_bid !== "fold"){
              roomobj.players[this_player].current_bid = "waiting"
            }
          }
        });
        
      }
    }
  }
  return roomobj;
}

function count_chips(roomobj){
  chips_total = 0;
  Object.keys(roomobj.players).forEach(function(player){
    chips_total += roomobj.players[player].current_pot;
  });
  return chips_total;
}

function pilot_create_room(){
  create_room("brapbrap","tdawg");
}

function create_room(collector_code,
                     player_name){
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  //detect if the collector_code exists
  var game_row = rowOfValue(master_sheet,   //looking within this
                            collector_code, //looking for this
                            0);             //looking in this column
  if(game_row == undefined){
    game_row = master_sheet.getLastRow()+1;
    var room_code = makeid(4);
    master_sheet.getRange(game_row, 1).setValue(collector_code);
    master_sheet.getRange(game_row, 2).setValue(room_code);
    master_sheet.getRange(game_row, 5).setValue(player_name);
    
  } else {
    //master_sheet.getRange(2, 2).setValue("failed");
    // this should never ever happen (or at least is very very unlikely)
  }
}
function pilot_everybody_in(collector_code){
  everybody_in("KRj75JmD4grZ");
}

function everybody_in(collector_code){
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  //detect if the collector_code exists
  var game_row = rowOfValue(master_sheet,   //looking within this
                            collector_code, //looking for this
                            0);             //looking in this column
  
  // create the room_obj
  players = {};
  for(var i = 5; i < 16; i++){
    var this_player = master_sheet.getRange(game_row,i).getValues()[0];
    if(this_player !== ""){
      players[this_player] = {
        player_no:i-5,
        chips:1000,
        current_hand:[],
        current_bid:"waiting"
      }      
    }
  }
  
  // somehow a blank player seems to come through
  if(typeof(players[""]) !== "undefined"){
    delete(players[""]);
  }
  
  roomobj = {
    small_blind:1,
    small_blind_player:0,
    players : players
  }
  master_sheet.getRange(game_row,15).setValue(true);
  
  master_sheet.getRange(game_row,3).setValue(JSON.stringify(roomobj));
  //deal the first hand
  
  deal_cards(fill_deck(),game_row);
  
  
}

function pilot_deal_cards(){
  deal_cards(fill_deck(),3)
}

function update_pot(){
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  //var roomobj = JSON.parse(master_sheet.getRange(game_row,3).getValues()[0]);
  
  
}

function deal_cards(this_deck,game_row){
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  
  var roomobj = JSON.parse(master_sheet.getRange(game_row,3).getValues()[0]);
  
  var players = Object.keys(roomobj.players);
  roomobj.small_blind_player++;
  
  roomobj.small_blind_player = roomobj.small_blind_player % players.length;
  roomobj.large_blind_player = (roomobj.small_blind_player + 1) % players.length;
  roomobj.first_bidder       = (roomobj.small_blind_player + 2) % players.length;
  roomobj.current_bidder     = roomobj.first_bidder;
  
  if(roomobj.small_blind_player > players.length - 1){
    roomobj.small_blind_player = 1;
  }
  players.forEach(function(player,player_no){
    // set the blinds
    //calculate modulus
    
    roomobj.players[player].last_bet = -1;
    
    if(player_no == roomobj.small_blind_player){
      roomobj.players[player].current_bid = "small blind";
      roomobj.players[player].chips = roomobj.players[player].chips - roomobj.small_blind;
      roomobj.players[player].current_pot = roomobj.small_blind;
    } else if(player_no == roomobj.large_blind_player){
      roomobj.players[player].current_bid = "large blind";
      roomobj.players[player].chips = roomobj.players[player].chips - roomobj.small_blind * 2;
      roomobj.players[player].current_pot = roomobj.small_blind * 2;
    } else {
      roomobj.players[player].current_bid = "waiting";
      roomobj.players[player].current_pot = 0;
    }
    if(player_no == roomobj.first_bidder){
      roomobj.turn = player;
      roomobj.players[player].current_bid = "your turn";
    }
    update_pot();
    
    // deal the cards
    var first_card = this_deck.pop();
    var second_card = this_deck.pop();
    roomobj.players[player].current_hand = [first_card,
                                            second_card];
  });
  roomobj.middle_cards = [];
  
  for(var i=0; i<5; i++){
    roomobj.middle_cards.push(this_deck.pop());
  }
  roomobj.round_phase = 0; //opening
  roomobj.this_deck = this_deck;
  
  master_sheet.getRange(game_row,3).setValue(JSON.stringify(roomobj));
}
function fill_deck(){
  this_deck = [];
  var suits = ["club","diamond","heart","spade"];
  for(var card_no = 2; card_no < 15; card_no++){
    var card_look = card_no;
    if(card_no > 10){
      switch(card_no){
        case 11:
          card_look = "jack";
          break;
        case 12:
          card_look = "queen";
          break;
        case 13:
          card_look = "king";
          break;
        case 14:
          card_look = "1";
          break;
      }
    }
    suits.forEach(function(suit){
      this_deck.push({
        card_file: suit + "_" + card_look + ".png",
        card_no:   card_no,
        suit:      suit
      });
    });
  }
  shuffled_deck = shuffle(this_deck);
  return shuffled_deck;
}
function join_room(collector_code,
                   player_name){
  player_name = player_name.toUpperCase();
  var master_sheet = SpreadsheetApp.openById("1lp9SwAtHytTGCJFfTkA9VUDz1mEk3Oez2xlDFapPt8g");
  master_sheet = master_sheet.getSheetByName('Sheet1');
  //detect if the collector_code exists
  var game_row = rowOfValue(master_sheet,   //looking within this
                            collector_code, //looking for this
                            0);             //looking in this column
  
  if(game_row == undefined){
    
  } else {
    //work out the participant number
    keep_searching = true;
    for(var i = 5; i < 15; i++){
      if(master_sheet.getRange(game_row,i).getValues()[0] == ""){
        if(keep_searching){
          master_sheet.getRange(game_row,i).setValue(player_name);
          keep_searching = false;
        }
      } else if(master_sheet.getRange(game_row,i).getValues()[0] == player_name){
        keep_searching = false;
      }
    }
    
    //complete_col = master_sheet.getDataRange().getValues()[0].length + 1;
    
    //master_sheet.getRange(2, 2).setValue("failed");
    // this should never ever happen (or at least is very very unlikely)
  }
}

//based on solution by csharptest.net at https://stackoverflow.com/questions/1349404/generate-random-string-characters-in-javascript
function makeid(length) {
  var result           = '';
  var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
  var charactersLength = characters.length;
  for ( var i = 0; i < length; i++ ) {
    result += characters.charAt(Math.floor(Math.random() * charactersLength));
  }
  return result;
}

//based on Stéphane's solution at https://stackoverflow.com/questions/32565859/find-cell-matching-value-and-return-rownumber/32567126
function rowOfValue(this_sheet,cell_value,column_index){  
  var data = this_sheet.getDataRange().getValues();  
  for(var i = 0; i<data.length;i++){
    if(data[i][column_index] == cell_value){
      return i+1;
    }
  }
}

// solution found at https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
function shuffle(array) {
  var currentIndex = array.length, temporaryValue, randomIndex;

  // While there remain elements to shuffle...
  while (0 !== currentIndex) {

    // Pick a remaining element...
    randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex -= 1;

    // And swap it with the current element.
    temporaryValue = array[currentIndex];
    array[currentIndex] = array[randomIndex];
    array[randomIndex] = temporaryValue;
  }

  return array;
}
*/
</script>